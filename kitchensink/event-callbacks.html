<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Event Callbacks - hyper-element Kitchen Sink</title>
  <script src="https://cdn.jsdelivr.net/npm/hyperhtml@latest/min.js"></script>
  <script src="test-loader.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    section { margin: 2rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 4px; }
    section[data-test-result="pass"] { border-color: green; background: #f0fff0; }
    section[data-test-result="fail"] { border-color: red; background: #fff0f0; }
    h1 { border-bottom: 2px solid #333; }
    h2 { margin-top: 0; }
    pre { background: #f5f5f5; padding: 1rem; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>Event Callbacks</h1>
  <p>Demonstrates using attachStore() without arguments for external event callbacks.</p>

  <section data-test="event-callback-no-store" data-test-result="pending">
    <h2>External Event Trigger (No Store)</h2>
    <p>Calling attachStore() without arguments returns a trigger function for re-rendering.</p>
    <pre><code>// External event system
const triggerRender = attachStore() // No store function

externalEventSource.on('message', (msg) => {
  this.messages.push(msg)
  triggerRender() // Re-renders the element
})</code></pre>
    <event-elem></event-elem>
    <script>
      // Simulate external event system
      const eventCallbacks = [];
      function onExternalEvent(cb) { eventCallbacks.push(cb); }
      function emitExternalEvent(data) { eventCallbacks.forEach(cb => cb(data)); }

      customElements.define("event-elem", class extends hyperElement {
        constructor() {
          super();
          this.count = 0;
        }

        setup(attachStore) {
          // Use attachStore without arguments - should return a trigger function
          const triggerRender = attachStore();

          onExternalEvent((data) => {
            this.count = data;
            triggerRender();
          });
        }

        render(Html) {
          Html`<div id="event-result">Count: ${this.count}</div>`
        }
      });

      // Test: emit events and verify re-render
      setTimeout(() => {
        emitExternalEvent(5);
        setTimeout(() => {
          emitExternalEvent(10);
          setTimeout(() => {
            const section = document.querySelector('[data-test="event-callback-no-store"]');
            const result = document.querySelector('#event-result');
            if (result && result.textContent.includes('Count: 10')) {
              section.dataset.testResult = 'pass';
            } else {
              section.dataset.testResult = 'fail';
            }
          }, 100);
        }, 100);
      }, 100);
    </script>
  </section>

  <section data-test="event-callback-with-data" data-test-result="pending">
    <h2>External Event with Data Passed to Render</h2>
    <p>The trigger function can also pass data directly to render().</p>
    <pre><code>const triggerRender = attachStore()
externalEventSource.on('message', (msg) => {
  triggerRender(msg) // Passes msg to render()
})</code></pre>
    <event-data-elem></event-data-elem>
    <script>
      const dataEventCallbacks = [];
      function onDataEvent(cb) { dataEventCallbacks.push(cb); }
      function emitDataEvent(data) { dataEventCallbacks.forEach(cb => cb(data)); }

      customElements.define("event-data-elem", class extends hyperElement {
        setup(attachStore) {
          const triggerRender = attachStore();

          onDataEvent((data) => {
            triggerRender(data); // Pass data directly to render
          });
        }

        render(Html, data) {
          Html`<div id="event-data-result">Data: ${data || 'none'}</div>`
        }
      });

      setTimeout(() => {
        emitDataEvent('PASS');
        setTimeout(() => {
          const section = document.querySelector('[data-test="event-callback-with-data"]');
          const result = document.querySelector('#event-data-result');
          if (result && result.textContent.includes('Data: PASS')) {
            section.dataset.testResult = 'pass';
          } else {
            section.dataset.testResult = 'fail';
          }
        }, 100);
      }, 200);
    </script>
  </section>

  <a href="index.html">&larr; Back to Kitchen Sink</a>
</body>
</html>
