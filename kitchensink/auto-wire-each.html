<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Auto-wire Each - hyper-element Kitchen Sink</title>
    <script src="test-loader.js"></script>
    <style>
      body {
        font-family: sans-serif;
        padding: 2rem;
      }
      section {
        margin: 2rem 0;
        padding: 1rem;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      section[data-test-result='pass'] {
        border-color: green;
        background: #f0fff0;
      }
      section[data-test-result='fail'] {
        border-color: red;
        background: #fff0f0;
      }
      h1 {
        border-bottom: 2px solid #333;
      }
      h2 {
        margin-top: 0;
      }
      pre {
        background: #f5f5f5;
        padding: 1rem;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <h1>Auto-wire {+each} Tests</h1>
    <p>Tests for the {+each}...{-each} syntax sugar for Html.wire().</p>

    <!-- Test: Basic list rendering -->
    <section data-test="basic-list" data-test-result="pending">
      <h2>Basic List Rendering</h2>
      <p>Renders a simple list with {+each} syntax.</p>
      <div id="basic-list-output"></div>
      <script>
        customElements.define(
          'each-basic-elem',
          class extends hyperElement {
            render(Html) {
              const users = [
                { name: 'Alice' },
                { name: 'Bob' },
                { name: 'Charlie' },
              ];
              Html`<ul id="each-basic-result">{+each ${users}}<li>{name}</li>{-each}</ul>`;
            }
          }
        );

        const elem1 = document.createElement('each-basic-elem');
        document.getElementById('basic-list-output').appendChild(elem1);

        requestAnimationFrame(() => {
          const section = document.querySelector('[data-test="basic-list"]');
          const result = document.getElementById('each-basic-result');
          const items = result?.querySelectorAll('li') || [];
          if (
            items.length === 3 &&
            items[0].textContent === 'Alice' &&
            items[1].textContent === 'Bob' &&
            items[2].textContent === 'Charlie'
          ) {
            section.dataset.testResult = 'pass';
          } else {
            section.dataset.testResult = 'fail';
            console.error('Basic list test failed:', result?.innerHTML);
          }
        });
      </script>
    </section>

    <!-- Test: Multiple properties -->
    <section data-test="multiple-props" data-test-result="pending">
      <h2>Multiple Properties</h2>
      <p>Renders items with multiple property references.</p>
      <div id="multiple-props-output"></div>
      <script>
        customElements.define(
          'each-multi-elem',
          class extends hyperElement {
            render(Html) {
              const users = [
                { name: 'Alice', age: 30 },
                { name: 'Bob', age: 25 },
              ];
              Html`<ul id="each-multi-result">{+each ${users}}<li>{name} ({age})</li>{-each}</ul>`;
            }
          }
        );

        const elem2 = document.createElement('each-multi-elem');
        document.getElementById('multiple-props-output').appendChild(elem2);

        requestAnimationFrame(() => {
          const section = document.querySelector(
            '[data-test="multiple-props"]'
          );
          const result = document.getElementById('each-multi-result');
          const items = result?.querySelectorAll('li') || [];
          if (
            items.length === 2 &&
            items[0].textContent === 'Alice (30)' &&
            items[1].textContent === 'Bob (25)'
          ) {
            section.dataset.testResult = 'pass';
          } else {
            section.dataset.testResult = 'fail';
            console.error('Multiple props test failed:', result?.innerHTML);
          }
        });
      </script>
    </section>

    <!-- Test: Nested property access -->
    <section data-test="nested-props" data-test-result="pending">
      <h2>Nested Property Access</h2>
      <p>Accesses nested object properties with dot notation.</p>
      <div id="nested-props-output"></div>
      <script>
        customElements.define(
          'each-nested-elem',
          class extends hyperElement {
            render(Html) {
              const users = [
                { name: 'Alice', address: { city: 'NYC' } },
                { name: 'Bob', address: { city: 'LA' } },
              ];
              Html`<ul id="each-nested-result">{+each ${users}}<li>{name} - {address.city}</li>{-each}</ul>`;
            }
          }
        );

        const elem3 = document.createElement('each-nested-elem');
        document.getElementById('nested-props-output').appendChild(elem3);

        requestAnimationFrame(() => {
          const section = document.querySelector('[data-test="nested-props"]');
          const result = document.getElementById('each-nested-result');
          const items = result?.querySelectorAll('li') || [];
          if (
            items.length === 2 &&
            items[0].textContent === 'Alice - NYC' &&
            items[1].textContent === 'Bob - LA'
          ) {
            section.dataset.testResult = 'pass';
          } else {
            section.dataset.testResult = 'fail';
            console.error('Nested props test failed:', result?.innerHTML);
          }
        });
      </script>
    </section>

    <!-- Test: Primitive arrays with {...} -->
    <section data-test="primitive-array" data-test-result="pending">
      <h2>Primitive Arrays with {...}</h2>
      <p>Uses {...} to reference current item in primitive arrays.</p>
      <div id="primitive-array-output"></div>
      <script>
        customElements.define(
          'each-primitive-elem',
          class extends hyperElement {
            render(Html) {
              const numbers = [1, 2, 3];
              Html`<ul id="each-primitive-result">{+each ${numbers}}<li>{...}</li>{-each}</ul>`;
            }
          }
        );

        const elem4 = document.createElement('each-primitive-elem');
        document.getElementById('primitive-array-output').appendChild(elem4);

        requestAnimationFrame(() => {
          const section = document.querySelector(
            '[data-test="primitive-array"]'
          );
          const result = document.getElementById('each-primitive-result');
          const items = result?.querySelectorAll('li') || [];
          if (
            items.length === 3 &&
            items[0].textContent === '1' &&
            items[1].textContent === '2' &&
            items[2].textContent === '3'
          ) {
            section.dataset.testResult = 'pass';
          } else {
            section.dataset.testResult = 'fail';
            console.error('Primitive array test failed:', result?.innerHTML);
          }
        });
      </script>
    </section>

    <!-- Test: {@index} reference -->
    <section data-test="index-ref" data-test-result="pending">
      <h2>{@index} Reference</h2>
      <p>Uses {@index} to show the current array index.</p>
      <div id="index-ref-output"></div>
      <script>
        customElements.define(
          'each-index-elem',
          class extends hyperElement {
            render(Html) {
              const items = [{ name: 'First' }, { name: 'Second' }];
              Html`<ul id="each-index-result">{+each ${items}}<li>{@}: {name}</li>{-each}</ul>`;
            }
          }
        );

        const elem5 = document.createElement('each-index-elem');
        document.getElementById('index-ref-output').appendChild(elem5);

        requestAnimationFrame(() => {
          const section = document.querySelector('[data-test="index-ref"]');
          const result = document.getElementById('each-index-result');
          const items = result?.querySelectorAll('li') || [];
          if (
            items.length === 2 &&
            items[0].textContent === '0: First' &&
            items[1].textContent === '1: Second'
          ) {
            section.dataset.testResult = 'pass';
          } else {
            section.dataset.testResult = 'fail';
            console.error('Index ref test failed:', result?.innerHTML);
          }
        });
      </script>
    </section>

    <!-- Test: Empty array -->
    <section data-test="empty-array" data-test-result="pending">
      <h2>Empty Array</h2>
      <p>Renders nothing for an empty array.</p>
      <div id="empty-array-output"></div>
      <script>
        customElements.define(
          'each-empty-elem',
          class extends hyperElement {
            render(Html) {
              const items = [];
              Html`<div id="each-empty-result"><span>before</span>{+each ${items}}<li>{name}</li>{-each}<span>after</span></div>`;
            }
          }
        );

        const elem6 = document.createElement('each-empty-elem');
        document.getElementById('empty-array-output').appendChild(elem6);

        requestAnimationFrame(() => {
          const section = document.querySelector('[data-test="empty-array"]');
          const result = document.getElementById('each-empty-result');
          const lis = result?.querySelectorAll('li') || [];
          const spans = result?.querySelectorAll('span') || [];
          if (
            lis.length === 0 &&
            spans.length === 2 &&
            spans[0].textContent === 'before' &&
            spans[1].textContent === 'after'
          ) {
            section.dataset.testResult = 'pass';
          } else {
            section.dataset.testResult = 'fail';
            console.error('Empty array test failed:', result?.innerHTML);
          }
        });
      </script>
    </section>

    <!-- Test: XSS prevention -->
    <section data-test="xss-prevention" data-test-result="pending">
      <h2>XSS Prevention</h2>
      <p>Property values should be escaped to prevent XSS.</p>
      <div id="xss-prevention-output"></div>
      <script>
        customElements.define(
          'each-xss-elem',
          class extends hyperElement {
            render(Html) {
              // Use concatenation to avoid HTML parser issues
              const malicious = '<scr' + 'ipt>alert("XSS")<\/scr' + 'ipt>';
              const users = [{ name: malicious }];
              Html`<ul id="each-xss-result">{+each ${users}}<li>{name}</li>{-each}</ul>`;
            }
          }
        );

        const elem7 = document.createElement('each-xss-elem');
        document.getElementById('xss-prevention-output').appendChild(elem7);

        requestAnimationFrame(() => {
          const section = document.querySelector(
            '[data-test="xss-prevention"]'
          );
          const result = document.getElementById('each-xss-result');
          const li = result?.querySelector('li');
          // The script tag should be escaped, shown as text
          if (
            li &&
            li.textContent.includes('<script>') &&
            li.innerHTML.includes('&lt;script&gt;')
          ) {
            section.dataset.testResult = 'pass';
          } else {
            section.dataset.testResult = 'fail';
            console.error('XSS prevention test failed:', result?.innerHTML);
          }
        });
      </script>
    </section>

    <!-- Test: DOM reuse verification -->
    <section data-test="dom-reuse" data-test-result="pending">
      <h2>DOM Reuse (Wire)</h2>
      <p>Verifies that DOM nodes are reused on re-render (via wire).</p>
      <div id="dom-reuse-output"></div>
      <script>
        // Keep the same object references across renders
        const reuseUsers = [{ name: 'Alice' }, { name: 'Bob' }];

        customElements.define(
          'each-reuse-elem',
          class extends hyperElement {
            render(Html) {
              Html`<ul id="each-reuse-result">{+each ${reuseUsers}}<li>{name}</li>{-each}</ul>`;
            }
          }
        );

        const elem8 = document.createElement('each-reuse-elem');
        document.getElementById('dom-reuse-output').appendChild(elem8);

        requestAnimationFrame(() => {
          const result = document.getElementById('each-reuse-result');
          const firstLi = result?.querySelector('li');

          // Mark the first li with a custom property
          if (firstLi) {
            firstLi._testMarker = 'original';
          }

          // Re-render with SAME data objects (update a property to trigger render)
          reuseUsers[0].name = 'Alice Updated';
          elem8.render(elem8.Html);

          requestAnimationFrame(() => {
            const section = document.querySelector('[data-test="dom-reuse"]');
            const newFirstLi = result?.querySelector('li');

            // If wire is working, the same DOM node should be reused
            // (even though the content changed, the node is the same)
            if (newFirstLi && newFirstLi._testMarker === 'original') {
              section.dataset.testResult = 'pass';
            } else {
              section.dataset.testResult = 'fail';
              console.error('DOM reuse test failed - node was recreated');
            }
          });
        });
      </script>
    </section>

    <!-- Test: Nested each blocks -->
    <section data-test="nested-each" data-test-result="pending">
      <h2>Nested Each Blocks</h2>
      <p>Renders nested lists using {+each {property}} syntax.</p>
      <div id="nested-each-output"></div>
      <script>
        customElements.define(
          'each-nested-list-elem',
          class extends hyperElement {
            render(Html) {
              const categories = [
                {
                  name: 'Fruits',
                  items: [{ title: 'Apple' }, { title: 'Banana' }],
                },
                { name: 'Veggies', items: [{ title: 'Carrot' }] },
              ];
              Html`<div id="each-nested-list-result">{+each ${categories}}<section><h3>{name}</h3><ul>{+each {items}}<li>{title}</li>{-each}</ul></section>{-each}</div>`;
            }
          }
        );

        const elem9 = document.createElement('each-nested-list-elem');
        document.getElementById('nested-each-output').appendChild(elem9);

        requestAnimationFrame(() => {
          const section = document.querySelector('[data-test="nested-each"]');
          const result = document.getElementById('each-nested-list-result');
          const sections = result?.querySelectorAll('section') || [];
          const h3s = result?.querySelectorAll('h3') || [];
          const lis = result?.querySelectorAll('li') || [];

          if (
            sections.length === 2 &&
            h3s.length === 2 &&
            h3s[0].textContent === 'Fruits' &&
            h3s[1].textContent === 'Veggies' &&
            lis.length === 3 &&
            lis[0].textContent === 'Apple' &&
            lis[1].textContent === 'Banana' &&
            lis[2].textContent === 'Carrot'
          ) {
            section.dataset.testResult = 'pass';
          } else {
            section.dataset.testResult = 'fail';
            console.error('Nested each test failed:', result?.innerHTML);
          }
        });
      </script>
    </section>

    <script>
      // Summary at the end
      window.addEventListener('load', () => {
        setTimeout(() => {
          const tests = document.querySelectorAll('[data-test]');
          const passed = document.querySelectorAll(
            '[data-test-result="pass"]'
          ).length;
          const failed = document.querySelectorAll(
            '[data-test-result="fail"]'
          ).length;
          const pending = document.querySelectorAll(
            '[data-test-result="pending"]'
          ).length;
          console.log(
            `Tests: ${passed} passed, ${failed} failed, ${pending} pending`
          );
        }, 500);
      });
    </script>
  </body>
</html>
