<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Block Syntax Advanced - hyper-element Kitchen Sink</title>
    <script src="test-loader.js"></script>
    <style>
      body {
        font-family: sans-serif;
        padding: 2rem;
      }
      section {
        margin: 2rem 0;
        padding: 1rem;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      section[data-test-result='pass'] {
        border-color: green;
        background: #f0fff0;
      }
      section[data-test-result='fail'] {
        border-color: red;
        background: #fff0f0;
      }
      h1 {
        border-bottom: 2px solid #333;
      }
      h2 {
        margin-top: 0;
      }
    </style>
  </head>
  <body>
    <h1>Block Syntax Advanced Tests</h1>
    <p>Tests for {+if}, {+each}, {+unless} block syntax edge cases.</p>

    <!-- Test: Conditional rendering inside each using wire -->
    <section data-test="nested-if-each" data-test-result="pending">
      <h2>Conditional Inside {+each} (via wire)</h2>
      <p>Tests conditional rendering inside loops using Html.wire().</p>
      <div id="nested-if-each-output"></div>
      <script>
        (function () {
          const section = document.querySelector('[data-test="nested-if-each"]');

          customElements.define(
            'nested-if-each-elem',
            class extends hyperElement {
              setup(onNext) {
                this.users = [
                  { name: 'Alice', admin: true },
                  { name: 'Bob', admin: false },
                  { name: 'Carol', admin: true },
                ];
                onNext();
              }
              render(Html) {
                // Use wire with conditional inside
                Html`<ul id="nested-if-each-result">${this.users.map(
                  (user) => Html.wire(user, ':user')`<li>${user.name}${user.admin ? ' (admin)' : ''}</li>`
                )}</ul>`;
              }
            }
          );

          const elem = document.createElement('nested-if-each-elem');
          document.getElementById('nested-if-each-output').appendChild(elem);

          requestAnimationFrame(() => {
            const lis = document.querySelectorAll('#nested-if-each-result li');
            if (
              lis.length === 3 &&
              lis[0].textContent.includes('Alice') &&
              lis[0].textContent.includes('(admin)') &&
              lis[1].textContent === 'Bob' &&
              !lis[1].textContent.includes('admin') &&
              lis[2].textContent.includes('(admin)')
            ) {
              section.dataset.testResult = 'pass';
            } else {
              section.dataset.testResult = 'fail';
            }
          });
        })();
      </script>
    </section>

    <!-- Test: Multiple if blocks -->
    <section data-test="multiple-if" data-test-result="pending">
      <h2>Multiple {+if} Blocks</h2>
      <p>Tests multiple independent {+if} blocks.</p>
      <div id="multiple-if-output"></div>
      <script>
        (function () {
          const section = document.querySelector('[data-test="multiple-if"]');

          customElements.define(
            'multiple-if-elem',
            class extends hyperElement {
              setup(onNext) {
                this.showA = true;
                this.showB = false;
                this.showC = true;
                onNext();
              }
              render(Html) {
                Html`<div id="multiple-if-result">{+if ${this.showA}}A{-if}{+if ${this.showB}}B{-if}{+if ${this.showC}}C{-if}</div>`;
              }
            }
          );

          const elem = document.createElement('multiple-if-elem');
          document.getElementById('multiple-if-output').appendChild(elem);

          requestAnimationFrame(() => {
            const result = document.getElementById('multiple-if-result');
            if (result?.textContent === 'AC') {
              section.dataset.testResult = 'pass';
            } else {
              section.dataset.testResult = 'fail';
            }
          });
        })();
      </script>
    </section>

    <!-- Test: Multiple each blocks -->
    <section data-test="multiple-each" data-test-result="pending">
      <h2>Multiple {+each} Blocks</h2>
      <p>Tests multiple independent {+each} blocks.</p>
      <div id="multiple-each-output"></div>
      <script>
        (function () {
          const section = document.querySelector('[data-test="multiple-each"]');

          customElements.define(
            'multiple-each-elem',
            class extends hyperElement {
              setup(onNext) {
                this.nums = [1, 2, 3];
                this.letters = ['a', 'b'];
                onNext();
              }
              render(Html) {
                Html`<div id="multiple-each-result">
                  <span class="nums">{+each ${this.nums}}{...}{-each}</span>
                  <span class="letters">{+each ${this.letters}}{...}{-each}</span>
                </div>`;
              }
            }
          );

          const elem = document.createElement('multiple-each-elem');
          document.getElementById('multiple-each-output').appendChild(elem);

          requestAnimationFrame(() => {
            const nums = document.querySelector('#multiple-each-result .nums');
            const letters = document.querySelector(
              '#multiple-each-result .letters'
            );
            if (nums?.textContent === '123' && letters?.textContent === 'ab') {
              section.dataset.testResult = 'pass';
            } else {
              section.dataset.testResult = 'fail';
            }
          });
        })();
      </script>
    </section>

    <!-- Test: {+each} with null array -->
    <section data-test="each-null" data-test-result="pending">
      <h2>{+each} with null Array</h2>
      <p>Tests {+each} when array is null.</p>
      <div id="each-null-output"></div>
      <script>
        (function () {
          const section = document.querySelector('[data-test="each-null"]');

          customElements.define(
            'each-null-elem',
            class extends hyperElement {
              setup(onNext) {
                this.items = null;
                onNext();
              }
              render(Html) {
                Html`<div id="each-null-result">start{+each ${this.items}}<span>{...}</span>{-each}end</div>`;
              }
            }
          );

          const elem = document.createElement('each-null-elem');
          document.getElementById('each-null-output').appendChild(elem);

          requestAnimationFrame(() => {
            const result = document.getElementById('each-null-result');
            // Should render "startend" with nothing in between
            if (result?.textContent === 'startend') {
              section.dataset.testResult = 'pass';
            } else {
              section.dataset.testResult = 'fail';
            }
          });
        })();
      </script>
    </section>

    <!-- Test: {+each} with undefined array -->
    <section data-test="each-undefined" data-test-result="pending">
      <h2>{+each} with undefined Array</h2>
      <p>Tests {+each} when array is undefined.</p>
      <div id="each-undefined-output"></div>
      <script>
        (function () {
          const section = document.querySelector('[data-test="each-undefined"]');

          customElements.define(
            'each-undefined-elem',
            class extends hyperElement {
              setup(onNext) {
                this.items = undefined;
                onNext();
              }
              render(Html) {
                Html`<div id="each-undefined-result">before{+each ${this.items}}<span>{...}</span>{-each}after</div>`;
              }
            }
          );

          const elem = document.createElement('each-undefined-elem');
          document.getElementById('each-undefined-output').appendChild(elem);

          requestAnimationFrame(() => {
            const result = document.getElementById('each-undefined-result');
            if (result?.textContent === 'beforeafter') {
              section.dataset.testResult = 'pass';
            } else {
              section.dataset.testResult = 'fail';
            }
          });
        })();
      </script>
    </section>

    <!-- Test: {+if} with else branch -->
    <section data-test="if-else-branch" data-test-result="pending">
      <h2>{+if} with {else} Branch</h2>
      <p>Tests {+if}...{else}...{-if} with both branches.</p>
      <div id="if-else-output"></div>
      <script>
        (function () {
          const section = document.querySelector('[data-test="if-else-branch"]');

          customElements.define(
            'if-else-elem',
            class extends hyperElement {
              setup(onNext) {
                this.isTrue = true;
                this.isFalse = false;
                onNext();
              }
              render(Html) {
                Html`<div id="if-else-result">
                  <span class="true">{+if ${this.isTrue}}YES{else}NO{-if}</span>
                  <span class="false">{+if ${this.isFalse}}YES{else}NO{-if}</span>
                </div>`;
              }
            }
          );

          const elem = document.createElement('if-else-elem');
          document.getElementById('if-else-output').appendChild(elem);

          requestAnimationFrame(() => {
            const t = document.querySelector('#if-else-result .true');
            const f = document.querySelector('#if-else-result .false');
            if (t?.textContent === 'YES' && f?.textContent === 'NO') {
              section.dataset.testResult = 'pass';
            } else {
              section.dataset.testResult = 'fail';
            }
          });
        })();
      </script>
    </section>

    <!-- Test: {+unless} with truthy value -->
    <section data-test="unless-truthy" data-test-result="pending">
      <h2>{+unless} with Truthy Value</h2>
      <p>Tests {+unless} hides content when true.</p>
      <div id="unless-truthy-output"></div>
      <script>
        (function () {
          const section = document.querySelector('[data-test="unless-truthy"]');

          customElements.define(
            'unless-truthy-elem',
            class extends hyperElement {
              setup(onNext) {
                this.hidden = true;
                this.shown = false;
                onNext();
              }
              render(Html) {
                Html`<div id="unless-truthy-result">
                  <span class="hidden">[{+unless ${this.hidden}}HIDDEN{-unless}]</span>
                  <span class="shown">[{+unless ${this.shown}}SHOWN{-unless}]</span>
                </div>`;
              }
            }
          );

          const elem = document.createElement('unless-truthy-elem');
          document.getElementById('unless-truthy-output').appendChild(elem);

          requestAnimationFrame(() => {
            const hidden = document.querySelector('#unless-truthy-result .hidden');
            const shown = document.querySelector('#unless-truthy-result .shown');
            if (hidden?.textContent === '[]' && shown?.textContent === '[SHOWN]') {
              section.dataset.testResult = 'pass';
            } else {
              section.dataset.testResult = 'fail';
            }
          });
        })();
      </script>
    </section>

    <!-- Test: Nested property access in each -->
    <section data-test="each-nested-prop" data-test-result="pending">
      <h2>{+each} with Nested Property Access</h2>
      <p>Tests accessing nested properties like {address.city}.</p>
      <div id="each-nested-output"></div>
      <script>
        (function () {
          const section = document.querySelector('[data-test="each-nested-prop"]');

          customElements.define(
            'each-nested-elem',
            class extends hyperElement {
              setup(onNext) {
                this.users = [
                  { name: 'Alice', address: { city: 'NYC' } },
                  { name: 'Bob', address: { city: 'LA' } },
                ];
                onNext();
              }
              render(Html) {
                Html`<ul id="each-nested-result">{+each ${this.users}}<li>{name} in {address.city}</li>{-each}</ul>`;
              }
            }
          );

          const elem = document.createElement('each-nested-elem');
          document.getElementById('each-nested-output').appendChild(elem);

          requestAnimationFrame(() => {
            const lis = document.querySelectorAll('#each-nested-result li');
            if (
              lis.length === 2 &&
              lis[0].textContent === 'Alice in NYC' &&
              lis[1].textContent === 'Bob in LA'
            ) {
              section.dataset.testResult = 'pass';
            } else {
              section.dataset.testResult = 'fail';
            }
          });
        })();
      </script>
    </section>

    <!-- Test: {@} index in each -->
    <section data-test="each-index" data-test-result="pending">
      <h2>{@} Index in {+each}</h2>
      <p>Tests {@} for current iteration index.</p>
      <div id="each-index-output"></div>
      <script>
        (function () {
          const section = document.querySelector('[data-test="each-index"]');

          customElements.define(
            'each-index-elem',
            class extends hyperElement {
              setup(onNext) {
                this.items = ['a', 'b', 'c'];
                onNext();
              }
              render(Html) {
                Html`<div id="each-index-result">{+each ${this.items}}{@}:{...},{-each}</div>`;
              }
            }
          );

          const elem = document.createElement('each-index-elem');
          document.getElementById('each-index-output').appendChild(elem);

          requestAnimationFrame(() => {
            const result = document.getElementById('each-index-result');
            if (result?.textContent === '0:a,1:b,2:c,') {
              section.dataset.testResult = 'pass';
            } else {
              section.dataset.testResult = 'fail';
            }
          });
        })();
      </script>
    </section>

    <!-- Test: {...} spread with objects -->
    <section data-test="each-spread-obj" data-test-result="pending">
      <h2>{...} Spread with Primitives</h2>
      <p>Tests {...} showing primitive values directly.</p>
      <div id="each-spread-output"></div>
      <script>
        (function () {
          const section = document.querySelector('[data-test="each-spread-obj"]');

          customElements.define(
            'each-spread-elem',
            class extends hyperElement {
              setup(onNext) {
                // Use primitives - objects show as [object Object]
                this.items = ['first', 'second', 'third'];
                onNext();
              }
              render(Html) {
                Html`<div id="each-spread-result">{+each ${this.items}}[{...}]{-each}</div>`;
              }
            }
          );

          const elem = document.createElement('each-spread-elem');
          document.getElementById('each-spread-output').appendChild(elem);

          requestAnimationFrame(() => {
            const result = document.getElementById('each-spread-result');
            if (result?.textContent === '[first][second][third]') {
              section.dataset.testResult = 'pass';
            } else {
              section.dataset.testResult = 'fail';
            }
          });
        })();
      </script>
    </section>

    <!-- Test: if with 0 (falsy) -->
    <section data-test="if-zero-falsy" data-test-result="pending">
      <h2>{+if} with 0 (Falsy)</h2>
      <p>Tests {+if} correctly treats 0 as falsy.</p>
      <div id="if-zero-output"></div>
      <script>
        (function () {
          const section = document.querySelector('[data-test="if-zero-falsy"]');

          customElements.define(
            'if-zero-elem',
            class extends hyperElement {
              setup(onNext) {
                this.zero = 0;
                this.one = 1;
                onNext();
              }
              render(Html) {
                Html`<div id="if-zero-result">
                  <span class="zero">[{+if ${this.zero}}SHOWN{-if}]</span>
                  <span class="one">[{+if ${this.one}}SHOWN{-if}]</span>
                </div>`;
              }
            }
          );

          const elem = document.createElement('if-zero-elem');
          document.getElementById('if-zero-output').appendChild(elem);

          requestAnimationFrame(() => {
            const zero = document.querySelector('#if-zero-result .zero');
            const one = document.querySelector('#if-zero-result .one');
            if (zero?.textContent === '[]' && one?.textContent === '[SHOWN]') {
              section.dataset.testResult = 'pass';
            } else {
              section.dataset.testResult = 'fail';
            }
          });
        })();
      </script>
    </section>

    <!-- Test: if with empty string (falsy) -->
    <section data-test="if-empty-str" data-test-result="pending">
      <h2>{+if} with Empty String (Falsy)</h2>
      <p>Tests {+if} correctly treats '' as falsy.</p>
      <div id="if-empty-str-output"></div>
      <script>
        (function () {
          const section = document.querySelector('[data-test="if-empty-str"]');

          customElements.define(
            'if-empty-str-elem',
            class extends hyperElement {
              setup(onNext) {
                this.empty = '';
                this.notEmpty = 'x';
                onNext();
              }
              render(Html) {
                Html`<div id="if-empty-str-result">
                  <span class="empty">[{+if ${this.empty}}SHOWN{-if}]</span>
                  <span class="not">[{+if ${this.notEmpty}}SHOWN{-if}]</span>
                </div>`;
              }
            }
          );

          const elem = document.createElement('if-empty-str-elem');
          document.getElementById('if-empty-str-output').appendChild(elem);

          requestAnimationFrame(() => {
            const empty = document.querySelector('#if-empty-str-result .empty');
            const not = document.querySelector('#if-empty-str-result .not');
            if (empty?.textContent === '[]' && not?.textContent === '[SHOWN]') {
              section.dataset.testResult = 'pass';
            } else {
              section.dataset.testResult = 'fail';
            }
          });
        })();
      </script>
    </section>

    <!-- Test: each with primitive array -->
    <section data-test="each-primitives" data-test-result="pending">
      <h2>{+each} with Primitive Array</h2>
      <p>Tests {+each} with array of strings/numbers.</p>
      <div id="each-primitives-output"></div>
      <script>
        (function () {
          const section = document.querySelector('[data-test="each-primitives"]');

          customElements.define(
            'each-primitives-elem',
            class extends hyperElement {
              setup(onNext) {
                this.strings = ['apple', 'banana', 'cherry'];
                this.numbers = [10, 20, 30];
                onNext();
              }
              render(Html) {
                Html`<div id="each-primitives-result">
                  <span class="str">{+each ${this.strings}}{...} {-each}</span>
                  <span class="num">{+each ${this.numbers}}{...} {-each}</span>
                </div>`;
              }
            }
          );

          const elem = document.createElement('each-primitives-elem');
          document.getElementById('each-primitives-output').appendChild(elem);

          requestAnimationFrame(() => {
            const str = document.querySelector('#each-primitives-result .str');
            const num = document.querySelector('#each-primitives-result .num');
            if (
              str?.textContent === 'apple banana cherry ' &&
              num?.textContent === '10 20 30 '
            ) {
              section.dataset.testResult = 'pass';
            } else {
              section.dataset.testResult = 'fail';
            }
          });
        })();
      </script>
    </section>

    <!-- Test: Complex nesting (each > if > each) -->
    <section data-test="complex-nesting" data-test-result="pending">
      <h2>Complex Nesting (each > if > content)</h2>
      <p>Tests deeply nested block structures.</p>
      <div id="complex-nesting-output"></div>
      <script>
        (function () {
          const section = document.querySelector('[data-test="complex-nesting"]');

          customElements.define(
            'complex-nesting-elem',
            class extends hyperElement {
              setup(onNext) {
                this.groups = [
                  { name: 'Active', active: true, count: 3 },
                  { name: 'Inactive', active: false, count: 0 },
                  { name: 'Pending', active: true, count: 1 },
                ];
                onNext();
              }
              render(Html) {
                Html`<div id="complex-nesting-result">{+each ${this.groups}}<div class="group">{name}{+if active}: {count} items{-if}</div>{-each}</div>`;
              }
            }
          );

          const elem = document.createElement('complex-nesting-elem');
          document.getElementById('complex-nesting-output').appendChild(elem);

          requestAnimationFrame(() => {
            const groups = document.querySelectorAll(
              '#complex-nesting-result .group'
            );
            if (
              groups.length === 3 &&
              groups[0].textContent.includes('Active: 3 items') &&
              groups[1].textContent === 'Inactive' &&
              groups[2].textContent.includes('Pending: 1 items')
            ) {
              section.dataset.testResult = 'pass';
            } else {
              section.dataset.testResult = 'fail';
            }
          });
        })();
      </script>
    </section>

    <!-- Test: Block with whitespace preservation -->
    <section data-test="block-whitespace" data-test-result="pending">
      <h2>Block Whitespace Handling</h2>
      <p>Tests that whitespace around blocks is handled correctly.</p>
      <div id="block-whitespace-output"></div>
      <script>
        (function () {
          const section = document.querySelector('[data-test="block-whitespace"]');

          customElements.define(
            'block-whitespace-elem',
            class extends hyperElement {
              setup(onNext) {
                this.show = true;
                onNext();
              }
              render(Html) {
                Html`<div id="block-whitespace-result">A {+if ${this.show}}B{-if} C</div>`;
              }
            }
          );

          const elem = document.createElement('block-whitespace-elem');
          document.getElementById('block-whitespace-output').appendChild(elem);

          requestAnimationFrame(() => {
            const result = document.getElementById('block-whitespace-result');
            if (result?.textContent === 'A B C') {
              section.dataset.testResult = 'pass';
            } else {
              section.dataset.testResult = 'fail';
            }
          });
        })();
      </script>
    </section>

    <a href="index.html">&larr; Back to Kitchen Sink</a>
  </body>
</html>
