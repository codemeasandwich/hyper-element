<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Child Redraw - hyper-element Kitchen Sink</title>
  <script src="https://cdn.jsdelivr.net/npm/hyperhtml@latest/min.js"></script>
  <script src="test-loader.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    section { margin: 2rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 4px; }
    section[data-test-result="pass"] { border-color: green; background: #f0fff0; }
    section[data-test-result="fail"] { border-color: red; background: #fff0f0; }
    h1 { border-bottom: 2px solid #333; }
    h2 { margin-top: 0; }
    pre { background: #f5f5f5; padding: 1rem; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>Child Redraw</h1>
  <p>Tests that child elements re-render when parent passes new values.</p>

  <!-- Issue #11: Child element NOT re-drawing -->
  <section data-test="child-redraw-on-parent-update" data-test-result="pending">
    <h2>Issue #11: Child Re-draws on Parent Update</h2>
    <p>When a parent element updates and passes new attribute values, the child should re-render.</p>
    <pre><code>// Parent re-renders every second with new time
// Child should display updated time
class Parent extends hyperElement {
  setup(attachStore) {
    setInterval(attachStore(() => new Date()), 1000)
  }
  render(Html, time) {
    Html\`&lt;child-elem name=${time + ""}&gt;&lt;/child-elem&gt;\`
  }
}

class Child extends hyperElement {
  render(Html) {
    Html\`Name: ${this.attrs.name}\`
  }
}</code></pre>
    <parent-redraw-elem></parent-redraw-elem>
    <div id="redraw-log"></div>
    <script>
      let childRenderCount = 0;
      let lastChildValue = null;

      customElements.define("child-redraw-elem", class extends hyperElement {
        // Note: Without observedAttributes, attributeChangedCallback won't fire!
        // static get observedAttributes() { return ['name', 'config']; }
        render(Html) {
          childRenderCount++;
          lastChildValue = this.attrs.name;
          console.log('Child render #' + childRenderCount + ', name:', this.attrs.name, 'config:', this.attrs.config);
          Html`<span id="child-display">Name: ${this.attrs.name}</span>`
        }
      });

      customElements.define("parent-redraw-elem", class extends hyperElement {
        setup(attachStore) {
          // Trigger re-render every 200ms with incrementing counter
          let counter = 0;
          const interval = setInterval(() => {
            counter++;
            attachStore(() => counter)();
          }, 200);

          return () => clearInterval(interval);
        }

        render(Html, counter) {
          console.log('Parent render, counter:', counter);
          // Pass counter as object attribute (triggers the shared attrs mechanism)
          Html`<child-redraw-elem name=${'value-' + counter} config=${{count: counter}}></child-redraw-elem>`
        }
      });

      // Check after 1 second - should have multiple child renders
      setTimeout(() => {
        const section = document.querySelector('[data-test="child-redraw-on-parent-update"]');
        const log = document.getElementById('redraw-log');
        log.textContent = `Child rendered ${childRenderCount} times, last value: ${lastChildValue}`;

        // Should have rendered at least 3 times (initial + updates)
        // and the value should be changing
        const pass = childRenderCount >= 3 && lastChildValue && lastChildValue.includes('value-');
        console.log('Test result: childRenderCount:', childRenderCount, 'lastChildValue:', lastChildValue, 'pass:', pass);
        section.dataset.testResult = pass ? 'pass' : 'fail';
      }, 1000);
    </script>
  </section>

  <a href="index.html">&larr; Back to Kitchen Sink</a>
</body>
</html>
