<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Dataset Mutations - hyper-element Kitchen Sink</title>
    <script src="https://cdn.jsdelivr.net/npm/hyperhtml@latest/min.js"></script>
    <script src="test-loader.js"></script>
    <style>
      body {
        font-family: sans-serif;
        padding: 2rem;
      }
      section {
        margin: 2rem 0;
        padding: 1rem;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      section[data-test-result='pass'] {
        border-color: green;
        background: #f0fff0;
      }
      section[data-test-result='fail'] {
        border-color: red;
        background: #fff0f0;
      }
      h1 {
        border-bottom: 2px solid #333;
      }
      h2 {
        margin-top: 0;
      }
      pre {
        background: #f5f5f5;
        padding: 1rem;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <h1>Dataset Mutations</h1>
    <p>
      Demonstrates modifying dataset properties and their reflection to DOM
      attributes.
    </p>

    <section data-test="dataset-add" data-test-result="pending">
      <h2>Adding Dataset Properties</h2>
      <p>Setting this.dataset.foo adds a data-foo attribute to the element.</p>
      <pre><code>class extends hyperElement {
  render(Html) {
    this.dataset.cats = "dogs"
    Html`dataset-add-element`
  }
}
// After render: element has data-cats="dogs" attribute</code></pre>
      <dataset-add-element></dataset-add-element>
      <script>
        customElements.define(
          'dataset-add-element',
          class extends hyperElement {
            render(Html) {
              this.count = this.count || 0;
              this.count++;
              if (this.count > 1) {
                return; // Prevent infinite re-render
              }
              this.dataset.cats = 'dogs';
              Html`dataset-add-element`;
            }
          }
        );

        requestAnimationFrame(() => {
          const section = document.querySelector('[data-test="dataset-add"]');
          const elem = document.querySelector('dataset-add-element');
          if (elem && elem.getAttribute('data-cats') === 'dogs') {
            section.dataset.testResult = 'pass';
          } else {
            section.dataset.testResult = 'fail';
          }
        });
      </script>
    </section>

    <section data-test="dataset-update" data-test-result="pending">
      <h2>Updating Dataset with Array</h2>
      <p>Arrays assigned to dataset are serialized to JSON in the attribute.</p>
      <pre><code>// Initial: data-json="[5,6]"
this.dataset.json = [5,6,7]
// After: data-json="[5,6,7]"</code></pre>
      <dataset-update-element data-json="[5,6]"></dataset-update-element>
      <script>
        customElements.define(
          'dataset-update-element',
          class extends hyperElement {
            render(Html) {
              this.count = this.count || 0;
              this.count++;
              if (this.count > 1) {
                return;
              }

              if (
                this.attrs['data-json'] !== '[5,6]' ||
                !Array.isArray(this.dataset.json) ||
                this.dataset.json.length !== 2
              ) {
                Html`dataset-update-element: initial check FAIL`;
                return;
              }
              this.dataset.json = [5, 6, 7];
              Html`dataset-update-element`;
            }
          }
        );

        requestAnimationFrame(() => {
          const section = document.querySelector(
            '[data-test="dataset-update"]'
          );
          const elem = document.querySelector('dataset-update-element');
          if (elem && elem.getAttribute('data-json') === '[5,6,7]') {
            section.dataset.testResult = 'pass';
          } else {
            section.dataset.testResult = 'fail';
          }
        });
      </script>
    </section>

    <section data-test="dataset-update-camelcase" data-test-result="pending">
      <h2>CamelCase Dataset Properties</h2>
      <p>Dataset properties with camelCase map to kebab-case attributes.</p>
      <pre><code>// data-a-b-c="[7,7,7]" maps to this.dataset.aBC
this.dataset.aBC = {zxy: 123}
// After: data-a-b-c='{"zxy":123}'</code></pre>
      <dataset-update2-element data-a-b-c="[7,7,7]"></dataset-update2-element>
      <script>
        customElements.define(
          'dataset-update2-element',
          class extends hyperElement {
            render(Html) {
              this.count = this.count || 0;
              this.count++;
              if (this.count > 1) {
                return;
              }

              if (
                this.attrs['data-a-b-c'] !== '[7,7,7]' ||
                typeof this.dataset.aBC !== 'object'
              ) {
                Html`dataset-update2-element: initial check FAIL`;
                return;
              }
              this.dataset.aBC = { zxy: 123 };
              Html`dataset-update2-element`;
            }
          }
        );

        requestAnimationFrame(() => {
          const section = document.querySelector(
            '[data-test="dataset-update-camelcase"]'
          );
          const elem = document.querySelector('dataset-update2-element');
          if (elem && elem.getAttribute('data-a-b-c') === '{"zxy":123}') {
            section.dataset.testResult = 'pass';
          } else {
            section.dataset.testResult = 'fail';
          }
        });
      </script>
    </section>

    <section data-test="dataset-remove-camelcase" data-test-result="pending">
      <h2>Removing CamelCase Dataset Properties</h2>
      <p>
        Removing a data attribute with hyphen (e.g., data-my-key) via
        removeAttribute should clean up this.dataset.myKey when
        observedAttributes includes it.
      </p>
      <pre><code>// Initial: data-my-key="value" maps to this.dataset.myKey
elem.removeAttribute('data-my-key')
// After: this.dataset.myKey is undefined</code></pre>
      <dataset-remove-elem data-my-key="initial-value"></dataset-remove-elem>
      <script>
        customElements.define(
          'dataset-remove-elem',
          class extends hyperElement {
            static get observedAttributes() {
              return ['data-my-key'];
            }
            render(Html) {
              Html`Value: ${this.dataset.myKey || 'removed'}`;
            }
          }
        );

        requestAnimationFrame(() => {
          const section = document.querySelector(
            '[data-test="dataset-remove-camelcase"]'
          );
          const elem = document.querySelector('dataset-remove-elem');

          // Verify initial state
          if (!elem || elem.dataset.myKey !== 'initial-value') {
            section.dataset.testResult = 'fail';
            console.error('Initial state wrong:', elem?.dataset?.myKey);
            return;
          }

          // Remove the attribute - triggers attributeChangedCallback
          elem.removeAttribute('data-my-key');

          // Wait for the callback and re-render
          setTimeout(() => {
            // Verify content changed to 'removed'
            if (elem.textContent.includes('removed')) {
              section.dataset.testResult = 'pass';
            } else {
              section.dataset.testResult = 'fail';
              console.error('Content did not update:', elem.textContent);
            }
          }, 100);
        });
      </script>
    </section>

    <a href="index.html">&larr; Back to Kitchen Sink</a>
  </body>
</html>
