<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Stress Test - hyper-element Kitchen Sink</title>
    <script src="test-loader.js"></script>
    <style>
      body {
        font-family: sans-serif;
        padding: 2rem;
      }
      section {
        margin: 2rem 0;
        padding: 1rem;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      section[data-test-result='pass'] {
        border-color: green;
        background: #f0fff0;
      }
      section[data-test-result='fail'] {
        border-color: red;
        background: #fff0f0;
      }
      h1 {
        border-bottom: 2px solid #333;
      }
      h2 {
        margin-top: 0;
      }
      .metrics {
        font-family: monospace;
        background: #f5f5f5;
        padding: 0.5rem;
        margin: 0.5rem 0;
      }
      .list-container {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ccc;
      }
    </style>
  </head>
  <body>
    <h1>Stress Tests</h1>
    <p>Performance tests with large data sets.</p>

    <!-- Test: Large list rendering (100 items) -->
    <section data-test="large-list" data-test-result="pending">
      <h2>Large List (100 Items)</h2>
      <p>Tests rendering a list with 100 items.</p>
      <div id="large-list-output"></div>
      <script>
        (function () {
          const section = document.querySelector('[data-test="large-list"]');

          customElements.define(
            'large-list-elem',
            class extends hyperElement {
              setup(onNext) {
                this.items = Array.from({ length: 100 }, (_, i) => ({
                  id: i,
                  name: 'Item ' + i,
                }));
                onNext();
              }
              render(Html) {
                Html`<div class="list-container">
                  <ul id="large-list-result">${this.items.map(
                    (item) => Html.wire(item, ':item')`<li>${item.name}</li>`
                  )}</ul>
                </div>`;
              }
            }
          );

          const elem = document.createElement('large-list-elem');
          document.getElementById('large-list-output').appendChild(elem);

          setTimeout(() => {
            const lis = document.querySelectorAll('#large-list-result li');
            if (
              lis.length === 100 &&
              lis[0].textContent === 'Item 0' &&
              lis[99].textContent === 'Item 99'
            ) {
              section.dataset.testResult = 'pass';
            } else {
              section.dataset.testResult = 'fail';
            }
          }, 500);
        })();
      </script>
    </section>

    <!-- Test: Rapid re-renders (50 quick updates) -->
    <section data-test="rapid-rerender" data-test-result="pending">
      <h2>Rapid Re-renders (50 Updates)</h2>
      <p>Tests 50 rapid render cycles.</p>
      <div id="rapid-rerender-output"></div>
      <script>
        (function () {
          const section = document.querySelector(
            '[data-test="rapid-rerender"]'
          );

          // Shared state that can be mutated externally
          const state = { count: 0 };

          customElements.define(
            'rapid-rerender-elem',
            class extends hyperElement {
              setup(onNext) {
                this.state = state;
                onNext();
              }
              render(Html) {
                Html`<div id="rapid-rerender-result">count=${this.state.count}</div>`;
              }
            }
          );

          const elem = document.createElement('rapid-rerender-elem');
          document.getElementById('rapid-rerender-output').appendChild(elem);

          setTimeout(() => {
            // Rapid updates via shared state
            for (let i = 1; i <= 50; i++) {
              state.count = i;
              elem.render();
            }

            setTimeout(() => {
              const result = document.getElementById('rapid-rerender-result');
              if (result?.textContent === 'count=50') {
                section.dataset.testResult = 'pass';
              } else {
                section.dataset.testResult = 'fail';
              }
            }, 50);
          }, 100);
        })();
      </script>
    </section>

    <!-- Test: Many elements on page -->
    <section data-test="many-elements" data-test-result="pending">
      <h2>Many Elements (20 Instances)</h2>
      <p>Tests creating 20 custom element instances.</p>
      <div id="many-elements-output"></div>
      <script>
        (function () {
          const section = document.querySelector('[data-test="many-elements"]');

          customElements.define(
            'many-elem-instance',
            class extends hyperElement {
              static get observedAttributes() {
                return ['index'];
              }
              render(Html) {
                Html`<span class="instance">I${this.attrs.index}</span>`;
              }
            }
          );

          const container = document.getElementById('many-elements-output');

          for (let i = 0; i < 20; i++) {
            const elem = document.createElement('many-elem-instance');
            elem.setAttribute('index', i);
            container.appendChild(elem);
          }

          setTimeout(() => {
            const instances = document.querySelectorAll(
              '#many-elements-output .instance'
            );
            if (
              instances.length === 20 &&
              instances[0].textContent === 'I0' &&
              instances[19].textContent === 'I19'
            ) {
              section.dataset.testResult = 'pass';
            } else {
              section.dataset.testResult = 'fail';
            }
          }, 200);
        })();
      </script>
    </section>

    <!-- Test: List updates (add/remove) -->
    <section data-test="list-updates" data-test-result="pending">
      <h2>List Updates (Add/Remove)</h2>
      <p>Tests dynamic list modifications.</p>
      <div id="list-updates-output"></div>
      <script>
        (function () {
          const section = document.querySelector('[data-test="list-updates"]');

          // Shared state object that can be mutated
          const state = {
            items: [
              { id: 1, name: 'A' },
              { id: 2, name: 'B' },
              { id: 3, name: 'C' },
            ],
          };

          customElements.define(
            'list-updates-elem',
            class extends hyperElement {
              setup(onNext) {
                // Store reference to shared state
                this.state = state;
                onNext();
              }
              render(Html) {
                Html`<ul id="list-updates-result">${this.state.items.map(
                  (item) => Html.wire(item, ':item')`<li>${item.name}</li>`
                )}</ul>`;
              }
            }
          );

          const elem = document.createElement('list-updates-elem');
          document.getElementById('list-updates-output').appendChild(elem);

          let passed = true;

          setTimeout(() => {
            // Test: Add item by mutating shared state
            state.items.push({ id: 4, name: 'D' });
            elem.render();

            setTimeout(() => {
              let lis = document.querySelectorAll('#list-updates-result li');
              if (lis.length !== 4 || lis[3].textContent !== 'D') {
                passed = false;
              }

              // Test: Remove item by mutating shared state
              state.items = state.items.filter((i) => i.id !== 2);
              elem.render();

              setTimeout(() => {
                lis = document.querySelectorAll('#list-updates-result li');
                if (lis.length !== 3) {
                  passed = false;
                }

                section.dataset.testResult = passed ? 'pass' : 'fail';
              }, 50);
            }, 50);
          }, 100);
        })();
      </script>
    </section>

    <!-- Test: Multiple interpolations -->
    <section data-test="many-interpolations" data-test-result="pending">
      <h2>Multiple Interpolations (20)</h2>
      <p>Tests template with 20 interpolation points.</p>
      <div id="many-interpolations-output"></div>
      <script>
        (function () {
          const section = document.querySelector(
            '[data-test="many-interpolations"]'
          );

          customElements.define(
            'many-interp-elem',
            class extends hyperElement {
              setup(onNext) {
                this.values = Array.from({ length: 20 }, (_, i) => 'v' + i);
                onNext();
              }
              render(Html) {
                Html`<div id="many-interp-result">${this.values.map(
                  (v, i) => Html.wire({ i }, ':v')`<span class="v">${v}</span>`
                )}</div>`;
              }
            }
          );

          const elem = document.createElement('many-interp-elem');
          document
            .getElementById('many-interpolations-output')
            .appendChild(elem);

          setTimeout(() => {
            const spans = document.querySelectorAll('#many-interp-result .v');
            if (
              spans.length === 20 &&
              spans[0].textContent === 'v0' &&
              spans[19].textContent === 'v19'
            ) {
              section.dataset.testResult = 'pass';
            } else {
              section.dataset.testResult = 'fail';
            }
          }, 200);
        })();
      </script>
    </section>

    <a href="index.html">&larr; Back to Kitchen Sink</a>
  </body>
</html>
